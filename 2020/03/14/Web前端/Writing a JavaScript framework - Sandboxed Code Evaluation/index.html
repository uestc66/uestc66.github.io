<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="true">








  <meta name="baidu-site-verification" content="RdqHn7VpTr">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml">



  <meta name="keywords" content="Web前端,">










<meta name="description" content="转载自网络，原文链接：https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/ This is the third chapter of the Writing a JavaScript framework series. In this chapter, I am going to">
<meta name="keywords" content="Web前端">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing a JavaScript framework - Sandboxed Code Evaluation">
<meta property="og:url" content="https://uestc66.github.io/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/index.html">
<meta property="og:site_name" content="jerry.zmf&#39;s blog">
<meta property="og:description" content="转载自网络，原文链接：https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/ This is the third chapter of the Writing a JavaScript framework series. In this chapter, I am going to">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_simple_with_statement-1470403007416.svg">
<meta property="og:image" content="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_with_statement_and_proxies-1470403030877.svg">
<meta property="og:image" content="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_security_issue-1470403047129.svg">
<meta property="og:image" content="https://blog.risingstack.com/content/images/2019/08/with_statements_and_proxies_has_and_get_traps-1470403073125.svg">
<meta property="og:updated_time" content="2020-03-12T16:26:49.758Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing a JavaScript framework - Sandboxed Code Evaluation">
<meta name="twitter:description" content="转载自网络，原文链接：https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/ This is the third chapter of the Writing a JavaScript framework series. In this chapter, I am going to">
<meta name="twitter:image" content="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_simple_with_statement-1470403007416.svg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://uestc66.github.io/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/">





  <title>Writing a JavaScript framework - Sandboxed Code Evaluation | jerry.zmf's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  
<div>

</div>
  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/uestc66"><img style="position: absolute; top: 0; right: 0; border: 0;" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">jerry.zmf's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">心有光芒，必有远方</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-gateway">
          <a href="/gateway/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            门户
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://uestc66.github.io/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jerry.zmf">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://img.alicdn.com/tfs/TB1fUIudbr1gK0jSZR0XXbP8XXa-479-479.jpg_mco0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jerry.zmf's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Writing a JavaScript framework - Sandboxed Code Evaluation</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-14T00:10:07+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web前端/" itemprop="url" rel="index">
                    <span itemprop="name">Web前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>阅读数
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><font color="#00BFFF" size="2">转载自网络，原文链接：<a href="https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/" target="_blank" rel="noopener">https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/</a></font></p>
<p><strong>This is the third chapter of the Writing a JavaScript framework series. In this chapter, I am going to explain the different ways of evaluating code in the browser and the issues they cause. I will also introduce a method, which relies on some new or lesser known JavaScript features.</strong></p>
<p><em>The series is about an open-source client-side framework, called NX. During the series, I explain the main difficulties I had to overcome while writing the framework. If you are interested in NX please visit the <a href="http://nx-framework.com/" target="_blank" rel="noopener">home page</a>.</em></p>
<p>The series includes the following chapters:</p>
<ol>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-project-structuring/" target="_blank" rel="noopener">Project structuring</a></li>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-execution-timing-beyond-settimeout/" target="_blank" rel="noopener">Execution timing</a></li>
<li>Sandboxed code evaluation (current chapter)</li>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-data-binding-dirty-checking/" target="_blank" rel="noopener">Data binding introduction</a></li>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-data-binding-es6-proxy/" target="_blank" rel="noopener">Data Binding with ES6 Proxies</a></li>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-the-benefits-of-custom-elements/" target="_blank" rel="noopener">Custom elements</a></li>
<li><a href="https://blog.risingstack.com/writing-a-javascript-framework-client-side-routing/" target="_blank" rel="noopener">Client-side routing</a></li>
</ol>
<h2 id="The-evil-eval"><a href="#The-evil-eval" class="headerlink" title="The evil eval"></a>The evil eval</h2><blockquote>
<p>The <code>eval()</code> function evaluates JavaScript code represented as a string.</p>
</blockquote>
<p>A common solution for code evaluation is the <code>eval()</code> function. Code evaluated by <code>eval()</code> has access to closures and the global scope, which leads to a security issue called <a href="https://en.wikipedia.org/wiki/Code_injection" target="_blank" rel="noopener">code injection</a> and makes <code>eval()</code> one of the most notorious features of JavaScript.</p>
<p>Despite being frowned upon, <code>eval()</code> is very useful in some situations. Most modern front-end frameworks require its functionality but don’t dare to use it because of the issue mentioned above. As a result, many alternative solutions emerged for evaluating strings in a sandbox instead of the global scope. The sandbox prevents the code from accessing secure data. Usually it is a simple JavaScript object, which replaces the global object for the evaluated code.</p>
<h2 id="The-common-way"><a href="#The-common-way" class="headerlink" title="The common way"></a>The common way</h2><p>The most common <code>eval()</code> alternative is complete re-implementation - a two-step process, which consists of parsing and interpreting the passed string. First the parser creates an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener">abstract syntax tree</a>, then the interpreter walks the tree and interprets it as code inside a sandbox.</p>
<p>This is a widely used solution, but it is arguably too heavy for such a simple thing. Rewriting everything from scratch instead of patching <code>eval()</code> introduces a lot of bug opportunities and it requires frequent modifications to follow the latest language updates as well.</p>
<h2 id="An-alternative-way"><a href="#An-alternative-way" class="headerlink" title="An alternative way"></a>An alternative way</h2><p><a href="http://nx-framework.com/" target="_blank" rel="noopener">NX</a> tries to avoid re-implementing native code. Evaluation is handled by a tiny library that uses some new or lesser known JavaScript features.</p>
<p>This section will progressively introduce these features and use them to explain the <a href="https://github.com/RisingStack/nx-compile" target="_blank" rel="noopener">nx-compile</a> code evaluation library. The library has a function called <code>compileCode()</code>, which works like below.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = compileCode(<span class="string">'return num1 + num2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// this logs 17 to the console</span></span><br><span class="line"><span class="built_in">console</span>.log(code(&#123;<span class="attr">num1</span>: <span class="number">10</span>, <span class="attr">num2</span>: <span class="number">7</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> globalNum = <span class="number">12</span></span><br><span class="line"><span class="keyword">const</span> otherCode = compileCode(<span class="string">'return globalNum'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// global scope access is prevented</span></span><br><span class="line"><span class="comment">// this logs undefined to the console</span></span><br><span class="line"><span class="built_in">console</span>.log(otherCode(&#123;<span class="attr">num1</span>: <span class="number">2</span>, <span class="attr">num2</span>: <span class="number">3</span>&#125;))</span><br></pre></td></tr></table></figure>

<p>By the end of this article, we will implement the <code>compileCode()</code> function in less than 20 lines.</p>
<h3 id="new-Function"><a href="#new-Function" class="headerlink" title="new Function()"></a>new Function()</h3><blockquote>
<p>The Function constructor creates a new Function object. In JavaScript, every function is actually a Function object.</p>
</blockquote>
<p>The <code>Function</code> constructor is an alternative to <code>eval()</code>. <code>new Function(...args, &#39;funcBody&#39;)</code> evaluates the passed <code>&#39;funcBody&#39;</code> string as code and returns a new function that executes that code. It differs from <code>eval()</code> in two major ways.</p>
<ul>
<li>It evaluates the passed code just once. Calling the returned function will run the code without re-evaluating it.</li>
<li>It doesn’t have access to local closure variables, however, it can still access the global scope.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileCode</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(src)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>new Function()</code> is a better alternative to <code>eval()</code> for our use case. It has superior performance and security, but global scope access still has to be prevented to make it viable.</p>
<h3 id="The-‘with’-keyword"><a href="#The-‘with’-keyword" class="headerlink" title="The ‘with’ keyword"></a>The ‘with’ keyword</h3><blockquote>
<p>The with statement extends the scope chain for a statement.</p>
</blockquote>
<p><code>with</code> is a lesser known keyword in JavaScript. It allows a semi-sandboxed execution. The code inside a <code>with</code> block tries to retrieve variables from the passed sandbox object first, but if it doesn’t find it there, it looks for the variable in the closure and global scope. Closure scope access is prevented by <code>new Function()</code> so we only have to worry about the global scope.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileCode</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = <span class="string">'with (sandbox) &#123;'</span> + src + <span class="string">'&#125;'</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'sandbox'</span>, src)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>with</code> uses the <code>in</code> operator internally. For every variable access inside the block, it evaluates the <code>variable in sandbox</code> condition. If the condition is truthy, it retrieves the variable from the sandbox. Otherwise, it looks for the variable in the global scope. By fooling <code>with</code> to always evaluate <code>variable in sandbox</code> as truthy, we could prevent it from accessing the global scope.</p>
<p><img src="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_simple_with_statement-1470403007416.svg" alt="Sandboxed code evaluation: Simple &#39;with&#39; statement"></p>
<h3 id="ES6-proxies"><a href="#ES6-proxies" class="headerlink" title="ES6 proxies"></a>ES6 proxies</h3><blockquote>
<p>The Proxy object is used to define custom behavior for fundamental operations like property lookup or assignment.</p>
</blockquote>
<p>An ES6 <code>Proxy</code> wraps an object and defines trap functions, which may intercept fundamental operations on that object. Trap functions are invoked when an operation occurs. By wrapping the sandbox object in a <code>Proxy</code> and defining a <code>has</code> trap, we can overwrite the default behavior of the <code>in</code> operator.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileCode</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = <span class="string">'with (sandbox) &#123;'</span> + src + <span class="string">'&#125;'</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'sandbox'</span>, src)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">sandbox</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> sandboxProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(sandbox, &#123;has&#125;)</span><br><span class="line">    <span class="keyword">return</span> code(sandboxProxy)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this trap intercepts 'in' operations on sandboxProxy</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has</span> (<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above code fools the <code>with</code> block. <code>variable in sandbox</code> will always evaluate to true because the <code>has</code> trap always returns true. The code inside the <code>with</code> block will never try to access the global object.</p>
<p><img src="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_with_statement_and_proxies-1470403030877.svg" alt="Sandboxed code evaluation: &#39;with&#39; statement and proxies"></p>
<h3 id="Symbol-unscopables"><a href="#Symbol-unscopables" class="headerlink" title="Symbol.unscopables"></a>Symbol.unscopables</h3><blockquote>
<p>A symbol is a unique and immutable data type and may be used as an identifier for object properties.</p>
</blockquote>
<p><code>Symbol.unscopables</code> is a well-known symbol. A well-known symbol is a built-in JavaScript <code>Symbol</code>, which represents internal language behavior. Well-known symbols can be used to add or overwrite iteration or primitive conversion behavior for example.</p>
<blockquote>
<p>The Symbol.unscopables well-known symbol is used to specify an object value of whose own and inherited property names are excluded from the ‘with’ environment bindings.</p>
</blockquote>
<p><code>Symbol.unscopables</code> defines the unscopable properties of an object. Unscopable properties are never retrieved from the sandbox object in <code>with</code> statements, instead they are retrieved straight from the closure or global scope. <code>Symbol.unscopables</code> is a very rarely used feature. You can read about the reason it was introduced on <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/unscopables" target="_blank" rel="noopener">this page</a>.</p>
<p><img src="https://blog.risingstack.com/content/images/2019/08/Sandboxed_code_evaluation_security_issue-1470403047129.svg" alt="Sandboxed code evaluation: &#39;with&#39; statement and proxies. A security issue."></p>
<p>We can fix above issue by defining a <code>get</code> trap on the sandbox <code>Proxy</code>, which intercepts <code>Symbol.unscopables</code> retrieval and always returns undefined. This will fool the <code>with</code> block into thinking that our sandbox object has no unscopable properties.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileCode</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = <span class="string">'with (sandbox) &#123;'</span> + src + <span class="string">'&#125;'</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'sandbox'</span>, src)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">sandbox</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> sandboxProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(sandbox, &#123;has, <span class="keyword">get</span>&#125;)</span><br><span class="line">    return code(sandboxProxy)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function has (target, key) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span> (<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key === <span class="built_in">Symbol</span>.unscopables) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> target[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.risingstack.com/content/images/2019/08/with_statements_and_proxies_has_and_get_traps-1470403073125.svg" alt="Sandboxed code evaluation: &#39;with&#39; statement and proxies. Has and get traps."></p>
<h3 id="WeakMaps-for-caching"><a href="#WeakMaps-for-caching" class="headerlink" title="WeakMaps for caching"></a>WeakMaps for caching</h3><p>The code is now secure, but its performance can be still upgraded, since it creates a new <code>Proxy</code> on every invocation of the returned function. This can be prevented by caching and using the same <code>Proxy</code> for every function call with the same sandbox object.</p>
<p>A proxy belongs to a sandbox object, so we could simply add the proxy to the sandbox object as a property. However, this would expose our implementation details to the public, and it wouldn’t work in case of an immutable sandbox object frozen with <code>Object.freeze()</code>. Using a <code>WeakMap</code> is a better alternative in this case.</p>
<blockquote>
<p>The WeakMap object is a collection of key/value pairs in which the keys are weakly referenced. The keys must be objects, and the values can be arbitrary values.</p>
</blockquote>
<p>A <code>WeakMap</code> can be used to attach data to an object without directly extending it with properties. We can use <code>WeakMaps</code> to indirectly add the cached <code>Proxies</code> to the sandbox objects.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sandboxProxies = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileCode</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = <span class="string">'with (sandbox) &#123;'</span> + src + <span class="string">'&#125;'</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'sandbox'</span>, src)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">sandbox</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sandboxProxies.has(sandbox)) &#123;</span><br><span class="line">      <span class="keyword">const</span> sandboxProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(sandbox, &#123;has, <span class="keyword">get</span>&#125;)</span><br><span class="line">      sandboxProxies.<span class="keyword">set</span>(sandbox, sandboxProxy)</span><br><span class="line">    &#125;</span><br><span class="line">    return code(sandboxProxies.<span class="keyword">get</span>(sandbox))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function has (target, key) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span> (<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key === <span class="built_in">Symbol</span>.unscopables) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> target[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This way only one <code>Proxy</code> will be created per sandbox object.</p>
<h3 id="Final-notes"><a href="#Final-notes" class="headerlink" title="Final notes"></a>Final notes</h3><p>The above <code>compileCode()</code> example is a working sandboxed code evaluator in just 19 lines of code. If you would like to see the full source code of the nx-compile library, you can find it in <a href="https://github.com/RisingStack/nx-compile" target="_blank" rel="noopener">this Github repository</a>.</p>
<p>Apart from explaining code evaluation, the goal of this chapter was to show how new ES6 features can be used to alter the existing ones, instead of re-inventing them. I tried to demonstrate the full power of <code>Proxies</code> and <code>Symbols</code> through the examples.</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    jerry.zmf
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://uestc66.github.io/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/" title="Writing a JavaScript framework - Sandboxed Code Evaluation">https://uestc66.github.io/2020/03/14/Web前端/Writing a JavaScript framework - Sandboxed Code Evaluation/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    


    
      <div>
          
      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Web前端/" rel="tag"><i class="fa fa-tag"></i> Web前端</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/13/门户/进阶门户/" rel="next" title="进阶门户">
                <i class="fa fa-chevron-left"></i> 进阶门户
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/16/Node.js/Node.js 进程间通信/" rel="prev" title="Node.js 进程间通信">
                Node.js 进程间通信 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://img.alicdn.com/tfs/TB1fUIudbr1gK0jSZR0XXbP8XXa-479-479.jpg_mco0.jpg" alt="jerry.zmf">
            
              <p class="site-author-name" itemprop="name">jerry.zmf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/uestc66" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/jerry-8-34-77/" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-gratipay"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="zhengmingfeng66@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-evil-eval"><span class="nav-number">1.</span> <span class="nav-text">The evil eval</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-common-way"><span class="nav-number">2.</span> <span class="nav-text">The common way</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#An-alternative-way"><span class="nav-number">3.</span> <span class="nav-text">An alternative way</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#new-Function"><span class="nav-number">3.1.</span> <span class="nav-text">new Function()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-‘with’-keyword"><span class="nav-number">3.2.</span> <span class="nav-text">The ‘with’ keyword</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES6-proxies"><span class="nav-number">3.3.</span> <span class="nav-text">ES6 proxies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Symbol-unscopables"><span class="nav-number">3.4.</span> <span class="nav-text">Symbol.unscopables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WeakMaps-for-caching"><span class="nav-number">3.5.</span> <span class="nav-text">WeakMaps for caching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Final-notes"><span class="nav-number">3.6.</span> <span class="nav-text">Final notes</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jerry.zmf</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
    <span class="site-uv">
      本站访客数<i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量<i class="fa fa-eye">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </i></span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'd3fAtsswhuE41kGfGd3OT3M7-gzGzoHsz',
        appKey: 'Kc4nsTUGGdxKAqgTnRtQMIwD',
        placeholder: 'Leave a comment',
        avatar:'/images/head_icon.jpg',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
